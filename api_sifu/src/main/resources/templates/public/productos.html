<!DOCTYPE html>
<html lang="es" layout:decorate="~{layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>
    <title>Inicio</title>
</head>
<body>
<div class="row" layout:fragment="content">
    <style>
        .categori-scroll {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding-bottom: 1rem;
            scroll-snap-type: x mandatory;
        }

        .categori-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .categori-scroll::-webkit-scrollbar-thumb {
            background-color: #bbb;
            border-radius: 4px;
        }

        .categoria-card {
            flex: 0 0 auto;
            width: 160px;
            scroll-snap-align: start;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background: white;
        }

        .categoria-card img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        .categoria-card .card-body {
            padding: 0.5rem;
            text-align: center;
        }

        .item-producto {
            height: 200px;
            max-width: 200px;
            min-width: 200px;
        }

        .item-producto .card-body {
            display: flex;
            flex-direction: column;
            padding: 2px;
        }
    </style>

    <div class="col-12">
        <h2 class="mb-1">Categorías de Productos</h2>
        <div class="categori-scroll" id="carouselCategorias"></div>

        <hr class="my-1">

        <h3 class="mb-1">Productos por Categoría</h3>
        <div id="productosContainer"></div>
    </div>
    <script>
        const imagenesPorDefecto = {
            "Frutas": "https://www.shutterstock.com/shutterstock/photos/2578716615/display_1500/stock-photo-tropical-fruits-are-fresh-sweet-and-full-of-flavor-juicy-mangoes-pineapples-and-bananas-bring-2578716615.jpg",
            "Verduras": "https://www.shutterstock.com/shutterstock/photos/2582378303/display_1500/stock-photo-different-fresh-vegetables-in-wicker-basket-isolated-on-white-2582378303.jpg",
            "Hortalizas": "https://www.shutterstock.com/shutterstock/photos/2260290449/display_1500/stock-photo-farmer-hands-holding-wooden-box-with-different-vegetables-2260290449.jpg",
            "Legumbres": "https://www.shutterstock.com/shutterstock/photos/2597071861/display_1500/stock-photo-mixed-pulses-for-healthy-and-balanced-diet-in-the-bowls-on-the-table-2597071861.jpg",
            "Cereales": "https://www.shutterstock.com/shutterstock/photos/2483755205/display_1500/stock-photo-wheat-grains-isolated-barley-pile-dry-cereal-seeds-for-bread-spelta-healthy-organic-food-wheat-2483755205.jpg",
            "Hierbas Aromáticas": "https://www.shutterstock.com/shutterstock/photos/2337582953/display_1500/stock-photo-different-fresh-potted-herbs-on-windowsill-indoors-2337582953.jpg"
        };

        function crearCardCategoria({id, nombre}) {
            const imgUrl = imagenesPorDefecto[nombre] || 'https://via.placeholder.com/160x100?text=Categoria';
            return `
                <div class="categoria-card">
                  <img src="${imgUrl}" alt="${nombre}">
                  <div class="card-body">
                    <h6 class="mb-0">${nombre}</h6>
                  </div>
                </div>
              `;
        }

        // Agregar al carrito
        function agregarItem(id) {
            producto = {
                "id": id
            }
            fetch(`${URL_BASE}/api/shop/add-item-cart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(producto)
                }
            ).then(async res => {
                const data = await res.json();

                if (!res.ok) {
                    // Mostrar mensaje de error personalizado
                    alert(`Error: ${data.msg}`);
                    throw new Error(data.msg);
                }
                // Si existe el mensaje o damos uno por defecto
                alert(data.msg || "Agregado correctamente");
            }).catch(err => {
                console.error("Error al agregar al carrito:", err);
            });
        }

        // Crear card para producto
        function crearCardProducto(prod) {
            const categoria = prod.categoriaProd?.nombre || 'Sin categoría';
            const imgUrl = prod.image;
            return `
                  <div class="col m-2">
                    <div class="item-producto card shadow-sm">
                      <img src="${imgUrl}" class="card-img-top h-50" alt="${prod.nombre}">
                      <div class="card-body text-center">
                        <p class="fw-bold">${prod.nombre}</p>
                        <label class="card-text text-muted">Categoría: ${categoria}</label>
                        <label class="card-text fw-bold">$${prod.precio.toFixed(2)}</label>
                        <p>
                        <button onclick="agregarItem(${prod.id})" type="button" class="btn btn-primary btn-sm"><i class="ti ti-shopping-cart-plus fs-6"></i></button>
                        </p>
                      </div>
                    </div>
                  </div>
                `;
        }

        // Mostrar productos agrupados por categoría
        function renderProductosPorCategoria(productos) {
            const contenedor = document.getElementById('productosContainer');

            // Agrupar productos por categoría
            const agrupado = {};
            productos.forEach(p => {
                const cat = p.categoriaProd?.nombre || 'Sin categoría';
                if (!agrupado[cat]) agrupado[cat] = [];
                agrupado[cat].push(p);
            });

            // Generar HTML
            contenedor.innerHTML = Object.entries(agrupado).map(([categoria, prods]) => `
                                  <h5 class="mt-4">${categoria}</h5>
                                  <div class="row">
                                    ${prods.map(crearCardProducto).join('')}
                                  </div>
                                `).join('');
        }

        // Cargar categorías
        fetch('http://localhost:8080/sifu/api/shop/categorias')
            .then(res => res.json())
            .then(json => {
                const container = document.getElementById('carouselCategorias');
                container.innerHTML = json.data.map(item => {
                    return crearCardCategoria({id: item.id, nombre: item.nombre});
                }).join('');
            });

        // Cargar productos
        fetch('http://localhost:8080/sifu/api/shop/productos')
            .then(res => res.json())
            .then(json => renderProductosPorCategoria(json.data));
    </script>
</div>
</body>
</html>