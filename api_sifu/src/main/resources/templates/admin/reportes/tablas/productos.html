<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<body>
	<div th:fragment="tbl-productos">

		<div class="container-fluid">
			<!-- Formulario de fechas -->
			<form id="filtro-form" class="row g-3 mb-3">
				<div class="col-md-3">
					<label for="fechaDesde" class="form-label">Desde</label> <input
						type="date" class="form-control" id="fechaDesde" name="desde">
				</div>
				<div class="col-md-3">
					<label for="fechaHasta" class="form-label">Hasta</label> <input
						type="date" class="form-control" id="fechaHasta" name="hasta">
				</div>
				<div class="col-md-2 align-self-end">
					<button type="submit" class="btn btn-primary w-100">Filtrar</button>
				</div>
			</form>

			<!-- Filtros por columnas -->
			<!--        <div class="row mb-3">-->
			<!--            <div class="col-md-3">-->
			<!--                <input type="text" class="form-control" placeholder="Filtrar por cliente" id="filtroCliente">-->
			<!--            </div>-->
			<!--            <div class="col-md-3">-->
			<!--                <input type="text" class="form-control" placeholder="Filtrar por producto" id="filtroProducto">-->
			<!--            </div>-->
			<!--            <div class="col-md-3">-->
			<!--                <input type="text" class="form-control" placeholder="Filtrar por agricultor" id="filtroAgricultor">-->
			<!--            </div>-->
			<!--        </div>-->

			<!-- Tabla -->
			<div class="table-responsive">
				<table
					class="table table-bordered table-striped table-hover align-middle"
					id="tabla-productos">
					<thead class="table-primary">
						<tr>
							<th>Categoría</th>
							<th>Producto</th>
							<th>Precio</th>
							<th>Cantidad</th>
							
						</tr>
					</thead>
					<tbody id="tbody-productos">
						<!-- filas dinámicas -->
					</tbody>
				</table>
			</div>
		</div>
		<script>

        function inicializarDataTable() {
            if ($.fn.DataTable.isDataTable('#tabla-productos')) {
                $('#tabla-reporte').DataTable().destroy();
            }

            dataTable = $('#tabla-productos').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'colvis', // para mostrar/ocultar columnas
                    {
                        extend: 'pdfHtml5',
                        text: 'PDF',
                        pageSize: 'A4',
                        exportOptions: {
                            columns: ':visible'
                        },
                        customize: function (doc) {
                            doc.defaultStyle.fontSize = 12;
                        }
                    },
                    'excelHtml5',
                    'print'
                ],
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50, 100],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                }
            });
        }
        document.addEventListener("DOMContentLoaded", () => {
            const tbody = document.getElementById("tbody-productos");

            const filtros = {
                categoria: document.getElementById("filtroCategoria"),
                producto: document.getElementById("filtroProducto2"),
                stock: document.getElementById("filtroStock")
            };

            function cargarDatos(desde = "", hasta = "") {
                let url = `http://localhost:8080/sifu/api/reporte/productos`;
                const params = new URLSearchParams();
                if (desde) params.append("desde", desde);
                if (hasta) params.append("hasta", hasta);
                if (params.toString()) url += `?${params.toString()}`;

                fetch(url)
                    .then(resp => resp.json())
                    .then(resp_json => {
                        tbody.innerHTML = "";
                        if (resp_json.code !=200){
                            alert("no existen datos")
                            return
                        }
                        data = resp_json.data
                        data.forEach(item => {
                            const row = document.createElement("tr");

                           row.innerHTML = `
    							<td>${item.categoria ?? ''}</td>
    							<td>${item.producto ?? ''}</td>
   								<td>${item.precioUnitario?.toFixed(2) ?? ''}</td>
    							<td>${item.cantidad ?? ''}</td>
    							
						   `;
                           

                            tbody.appendChild(row);
                        });

                        // aplicarFiltros();
                        inicializarDataTable();
                    })
                    .catch(err => console.error("Error:", err));
            }

            // Carga inicial
            cargarDatos();
        });
    </script>

	</div>
</body>