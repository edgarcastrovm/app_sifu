<!DOCTYPE html>
<html lang="es" layout:decorate="~{layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>
    <title>Perfil-Cliente</title>
</head>
<body>
<div class="row" layout:fragment="content">

    <div class="container mt-4">
        <h2>Carrito de Compras</h2>
        <div id="alerta" class="alert d-none" role="alert"></div>

        <ul class="list-group" id="lista-carrito"></ul>

        <div class="mt-3 d-flex justify-content-between align-items-center">
            <strong>Total seleccionado: <span id="total-general">$0.00</span></strong>
            <button class="btn btn-primary" onclick="facturarSeleccionados()">Facturar Seleccionados</button>
        </div>
    </div>
    <script>

        let carritoItems = [];

        async function listarItems() {
            try {
                const res = await fetch(`${URL_BASE}/api/shop/cliente/my-cart`);
                const json = await res.json();

                if (!res.ok) {
                    mostrarAlerta('danger', json.msg || 'Error al obtener el carrito');
                    throw new Error(json.msg);
                }

                carritoItems = json.data;
                renderizarCarrito();

            } catch (err) {
                console.error("Error:", err);
            }
        }

        function renderizarCarrito() {
            const lista = document.getElementById("lista-carrito");
            const totalGeneral = document.getElementById("total-general");
            lista.innerHTML = "";

            let totalSeleccionado = 0;

            carritoItems.forEach(item => {
                const cantidad = item.cantidad ?? 1;
                const precio = item.producto.precio;
                const subtotal = cantidad * precio;

                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-start";

                li.innerHTML = `
                <div class="form-check me-3">
                    <input class="form-check-input check-item" type="checkbox" value="${item.id}" onchange="actualizarTotalSeleccionado()">
                </div>
                <div class="ms-2 me-auto w-100">
                    <div class="fw-bold d-flex justify-content-between">
                        <span>${item.producto.nombre}</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="text-muted">${item.producto.categoriaProd.nombre}</div>
                    <div class="mt-2 d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-secondary" onclick="modificarCantidad(${item.id}, -1)">âˆ’</button>
                        <input type="number" name="" id="${item.id}-cantidad" value="${cantidad}"/>
                        <button class="btn btn-sm btn-secondary" onclick="modificarCantidad(${item.id}, 1)">+</button>
                        <button class="btn btn-sm btn-outline-danger ms-auto" onclick="eliminarItem(${item.id})">ðŸ—‘</button>
                    </div>
                </div>
            `;

                lista.appendChild(li);
            });

            actualizarTotalSeleccionado();
        }

        function modificarCantidad(id, delta) {
            // fetch(`${URL_BASE}/api/shop/update-item-cart/${id}?delta=${delta}`, {
            //     method: 'PUT'
            // })
            //     .then(res => res.json())
            //     .then(json => {
            //         mostrarAlerta('success', json.msg || 'Cantidad actualizada');
            //         listarItems();
            //     })
            //     .catch(err => console.error("Error al actualizar cantidad:", err));
            const input = document.getElementById(`${id}-cantidad`)
            input.value = parseInt(input.value) + delta
            console.log(input.value)
            actualizarTotalSeleccionado()
        }

        function eliminarItem(id) {
            if (!confirm("Â¿Eliminar este producto del carrito?")) return;

            fetch(`${URL_BASE}/api/shop/delete-item-cart/${id}`, {
                method: 'DELETE'
            })
                .then(res => res.json())
                .then(json => {
                    mostrarAlerta('info', json.msg || 'Producto eliminado');
                    listarItems();
                })
                .catch(err => console.error("Error al eliminar:", err));
        }

        function actualizarTotalSeleccionado() {
            const checkboxes = document.querySelectorAll('.check-item:checked');
            let total = 0;

            checkboxes.forEach(cb => {
                const item = carritoItems.find(i => i.id === parseInt(cb.value));
                const input = document.getElementById(`${item.id}-cantidad`)
                //const cantidad = item.cantidad ?? 1;
                const cantidad = parseInt(input.value) ?? 1;
                const precio = item.producto.precio;
                total += cantidad * precio;
            });

            document.getElementById('total-general').textContent = `$${total.toFixed(2)}`;
        }

        function facturarSeleccionados() {
            const checkboxes = document.querySelectorAll('.check-item:checked');
            const seleccionados = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (seleccionados.length === 0) {
                alert("Seleccione al menos un producto para facturar.");
                return;
            }

            console.log("Facturando IDs:", seleccionados);
            // AquÃ­ puedes enviar los IDs seleccionados al backend:
            // fetch(`${URL_BASE}/api/shop/facturar`, { method: 'POST', body: JSON.stringify(seleccionados) })
            alert("FacturaciÃ³n simulada. Ver consola.");
        }

        function mostrarAlerta(tipo, mensaje) {
            const alerta = document.getElementById('alerta');
            alerta.className = `alert alert-${tipo}`;
            alerta.textContent = mensaje;
            alerta.classList.remove('d-none');
            setTimeout(() => alerta.classList.add('d-none'), 3000);
        }

        document.addEventListener('DOMContentLoaded', listarItems);
    </script>
</div>
</body>

</html>
