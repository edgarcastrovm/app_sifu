<!DOCTYPE html>
<html lang="es" layout:decorate="~{layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>
    <title>Perfil-Cliente</title>
</head>
<body>
<div class="row" layout:fragment="content">
    <style>
        .txt-stock {
            max-width: 60px;
            padding: 0 0 0 4px;
            border-radius: .2rem;
        }

        .item-detalle {
            margin: 0;
            border-bottom: solid 1px #ccc;
            border-bottom-style: dashed;
        }
        #content-lista{
            overflow: auto;
            max-height: calc(100vh - 15vh);
            min-height: calc(100vh - 15vh);
        }
        #lista-items-factura {
            max-height: calc(100vh - 20vh);
            min-height: calc(100vh - 20vh);
            overflow: auto;
        }

        .image-product {
            min-height: 150px;
            max-height: 150px;
            min-width: 150px;
            max-width: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.25rem;
            background-color: var(--bs-body-bg);
            border: var(--bs-border-width) solid var(--bs-border-color);
            border-radius: var(--bs-border-radius);
            box-shadow: var(--bs-box-shadow-sm);
        }

        .image-product img {
            width: 100%;
            /*object-fit: cover;    !* recorta si es necesario *!*/
        }
    </style>
    <div id="alerta" class="alert d-none" role="alert"></div>
    <div class="row">
        <div id="content-lista" class="col-md-6 col-lg-8">
            <ul class="list-group" id="lista-carrito"></ul>
        </div>
        <div class="col-md-6 col-lg-4 card">
            <ul class="list-group" id="lista-items-factura"></ul>
            <div class="mt-3 d-flex justify-content-between align-items-center">
                <strong>Total seleccionado: <span id="total-general">$0.00</span></strong>
                <button class="btn btn-primary" onclick="facturarSeleccionados()">Facturar Seleccionados</button>
            </div>
        </div>
    </div>


    <script>
        let carritoItems = [];

        function crearListaAgricultor(idItem, idProducto) {

            const container = document.getElementById(`${idItem}-accordionAgricultores`);
            container.innerHTML = '';
            fetch(`${URL_BASE}/api/shop/agricultores/productos/${idProducto}`)
                .then(res => res.json())
                .then(json => {
                    if (!json.data || json.data.length === 0) {
                        document.getElementById('accordionAgricultores').innerHTML = '<p>No hay productores disponibles.</p>';
                        return;
                    }

                    renderizarAccordion(json.data, idItem);
                    llenarCombo(json.data, idItem);
                })
                .catch(err => console.error('Error al cargar productores:', err));
        }

        function crearListaAgricultorOpt(elementId,itemId,productId){
            const select = document.getElementById(elementId)
            if(select.childElementCount==1) {
                crearListaAgricultor(itemId, productId)
            }
            return true
        }

        function renderizarAccordion(data, idItem) {
            const container = document.getElementById(`${idItem}-accordionAgricultores`);
            container.innerHTML = '';
            let itemsDisponibles = '';
            data.forEach((item, index) => {
                const stockDisponible = item.stock > 0;
                const btn = `<button class="btn btn-primary btn-sm"
                                onclick="seleccionarAgricultor(${idItem},${item.idAgricultor}, '${item.nombreAgricultor}')">
                                <i class="ti ti-check"></i>
                            </button>`
                itemsDisponibles += `<tr>
                        <td>
                            <p class="item-detalle">${item.nombreAgricultor}</p>
                            <p class="item-detalle d-md-none d-lg-block">${item.correoAgricultor}</p>
                            <p class="item-detalle">${item.telefonoAgricultor}</p>
                        </td>
                        <td>${item.stock}</td>
                        <td>
                            ${stockDisponible ? btn:'<span class="text-danger">Sin stock</span>'}
                        </td>
                    </tr>`
            });

            const card = document.createElement('div');
            card.innerHTML = `
                <div  class="card p-2" >
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <th>Agricultor</th><th>Stock</th><th>AcciÃ³n</th>
                            </thead>
                            <tbody>${itemsDisponibles}</tbody>
                        </table>
                    </div>
                </div>
                `
            container.append(card);
        }
        function onChangeAgricultor(e) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const nombre = selectedOption.dataset.nombre;
            const stock = selectedOption.dataset.stock;

            console.log("ID:", e.target.value);
            console.log("Nombre:", nombre);
            console.log("Stock:", stock);

            alert(`Agricultor ${nombre} seleccionado.`);
        }
        function llenarCombo(data, idItem) {
            const combo = document.getElementById(`${idItem}-comboAgricultor`);
            combo.removeEventListener('change',onChangeAgricultor)
            combo.innerHTML = `<option value="">-- Seleccione un agricultor --</option>`;

            const unicos = data.filter(d => d.stock > 0);
            unicos.forEach(d => {
                const opt = document.createElement('option');
                opt.dataset.stock = d.stock
                opt.dataset.nombre = d.nombreAgricultor
                opt.value = d.idAgricultor;
                opt.textContent = `${d.nombreAgricultor} [stock:${ d.stock}]`;
                combo.appendChild(opt);
            });

            combo.addEventListener("change", onChangeAgricultor);
        }


        async function listarItems() {
            try {
                const res = await fetch(`${URL_BASE}/api/shop/cliente/my-cart`);
                const json = await res.json();
                if (!res.ok) {
                    mostrarAlerta('danger', json.msg || 'Error al obtener el carrito');
                    throw new Error(json.msg);
                }

                carritoItems = json.data;
                renderizarCarrito();

            } catch (err) {
                console.error("Error:", err);
            }
        }


        function renderizarCarrito() {
            const lista = document.getElementById("lista-carrito");
            const totalGeneral = document.getElementById("total-general");
            lista.innerHTML = "";

            let totalSeleccionado = 0;

            carritoItems.forEach(item => {
                console.log(item)
                const cantidad = item.cantidad ?? 1;
                const precio = item.producto.precio;
                const subtotal = cantidad * precio;

                const li = document.createElement("li");
                li.id = `${item.id}-producto`
                li.className = "list-group-item d-flex flex-sm-column flex-sm-column-reverse flex-lg-row  justify-content-between align-items-start";
                li.innerHTML = `
                <div class="card" >
                    <div class="card-header">
                        <div class="input-group">
                            <div class="input-group-text d-sm-none d-lg-block">
                                <label for="comboAgricultor" class="form-label">
                                Agricultor: </label>
                            </div>
                            <select id="${item.id}-comboAgricultor" class="form-select"
                            onmousedown="crearListaAgricultorOpt('${item.id}-comboAgricultor',${item.id},${item.producto.id})">
                                <option value="">-- Seleccione un agricultor --</option>
                            </select>
                            <div class="input-group-text">
                                <button class="btn-search btn btn-sm btn-primary"
                                   onclick="crearListaAgricultor(${item.id},${item.producto.id})"
                                   title="Buscar agricultores con este producto">
                                        <i class="ti ti-search"></i>
                               </button>
                            </div>
                        </div>
                    </div>
                        <div class="accordion">
                             <div class="accordion-item">
                                <h2 class="accordion-header">
                                  <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#${item.id}-accordionAgricultores-content" aria-expanded="true"
                                    aria-controls="${item.id}-accordionAgricultores-content">
                                    Agricultores disponibles
                                  </button>
                                </h2>
                                <div id="${item.id}-accordionAgricultores-content" class="accordion-collapse collapse" data-bs-parent="#accordionExample">

                                  <div id="${item.id}-accordionAgricultores" class="accordion-body" >
                                    <label>Da click en el boton buscar para poder visualizar los agricultores <i class="ti ti-search"></i></label>
                                  </div>
                                </div>
                             </div>
                        </div>
                </div>
                <div class="ms-2 me-auto auto d-flex flex-sm-column flex-lg-row">
                    <div class="fw-bold d-flex flex-column justify-content-between">
                        <picture class="image-product mb-1">
                            <img class="" src="${BASE_64_TO_IMAGE(item.producto.image)}"/>
                        </picture>
                    </div>
                    <div class="m-2 d-flex flex-column">
                        <span>${item.producto.nombre}</span>
                        <span>$${subtotal.toFixed(2)}</span>
                        <div class="text-muted">${item.producto.categoriaProd.nombre}</div>
                        <div class="form-check form-switch">
                          <input class="form-check-input check-item" type="checkbox" role="switch" id="${item.id}-chek" value="${item.id}" onchange="actualizarTotalSeleccionado()" />
                          <label class="form-check-label" for="${item.id}-chek">Facturar</label>
                        </div>
                        <div class="m-2 d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-secondary" onclick="modificarCantidad(${item.id}, -1)">âˆ’</button>
                            <input type="number" class="form-control txt-stock" min="1" max="999" id="${item.id}-cantidad" value="${cantidad}"/>
                            <button class="btn btn-sm btn-secondary" onclick="modificarCantidad(${item.id}, 1)">+</button>
                            <button class="btn btn-sm btn-outline-danger ms-auto" onclick="eliminarItem(${item.id})">ðŸ—‘</button>
                        </div>
                    </div>
                </div>
            `;

                lista.appendChild(li);
            });

            actualizarTotalSeleccionado();
        }

        function modificarCantidad(id, delta) {
            // fetch(`${URL_BASE}/api/shop/update-item-cart/${id}?delta=${delta}`, {
            //     method: 'PUT'
            // })
            //     .then(res => res.json())
            //     .then(json => {
            //         mostrarAlerta('success', json.msg || 'Cantidad actualizada');
            //         listarItems();
            //     })
            //     .catch(err => console.error("Error al actualizar cantidad:", err));
            const input = document.getElementById(`${id}-cantidad`)
            input.value = parseInt(input.value) + delta
            console.log(input.value)
            actualizarTotalSeleccionado()
        }

        function eliminarItem(id) {
            if (!confirm("Â¿Eliminar este producto del carrito?")) return;

            fetch(`${URL_BASE}/api/shop/cliente/my-cart/producto/${id}`, {
                method: 'DELETE'
            })
                .then(res => res.json())
                .then(json => {
                    mostrarAlerta('info', json.msg || 'Producto eliminado');
                    listarItems();
                })
                .catch(err => console.error("Error al eliminar:", err));
        }

        function actualizarTotalSeleccionado() {
            const checkboxes = document.querySelectorAll('.check-item:checked');
            let total = 0;

            checkboxes.forEach(cb => {
                const item = carritoItems.find(i => i.id === parseInt(cb.value));
                const input = document.getElementById(`${item.id}-cantidad`)
                //const cantidad = item.cantidad ?? 1;
                const cantidad = parseInt(input.value) ?? 1;
                const precio = item.producto.precio;
                total += cantidad * precio;
            });

            document.getElementById('total-general').textContent = `$${total.toFixed(2)}`;
        }

        function facturarSeleccionados() {
            const checkboxes = document.querySelectorAll('.check-item:checked');
            const seleccionados = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (seleccionados.length === 0) {
                alert("Seleccione al menos un producto para facturar.");
                return;
            }

            console.log("Facturando IDs:", seleccionados);
            // AquÃ­ puedes enviar los IDs seleccionados al backend:
            // fetch(`${URL_BASE}/api/shop/facturar`, { method: 'POST', body: JSON.stringify(seleccionados) })
            alert("FacturaciÃ³n simulada. Ver consola.");
        }

        function mostrarAlerta(tipo, mensaje) {
            const alerta = document.getElementById('alerta');
            alerta.className = `alert alert-${tipo}`;
            alerta.textContent = mensaje;
            alerta.classList.remove('d-none');
            setTimeout(() => alerta.classList.add('d-none'), 3000);
        }

        document.addEventListener('DOMContentLoaded', listarItems);
    </script>
</div>
</body>

</html>
